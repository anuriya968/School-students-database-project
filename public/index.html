<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>School Students Database</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>School Students Database</h1>
  <form id="studentForm">
    Name: <input name="name" required /><br/>
    Class: <input name="class" required /><br/>
    Age: <input name="age" type="number" required /><br/>
    Marks (JSON format): <textarea name="marks" placeholder='{"math": 90, "science": 80}'></textarea><br/>
    <button type="submit">Add Student</button>
  </form>
  <hr/>

  <h2>Students List</h2>
  <table id="studentsTable" border="1" cellpadding="10" cellspacing="0" style="margin: auto; width: 80%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Class</th>
        <th>Age</th>
        <th>Math</th>
        <th>English</th>
        <th>Science</th>
        <th>Chemistry</th>
      </tr>
    </thead>
    <tbody id="studentsTableBody">
      <!-- Student rows go here -->
    </tbody>
  </table>

  <script>

const form = document.getElementById('studentForm');
const studentsTableBody = document.getElementById('studentsTableBody');

let editingStudentId = null; // To track if we are editing a student

async function loadStudents() {
  try {
    const res = await fetch('/students');
    const students = await res.json();

    studentsTableBody.innerHTML = ''; // clear previous rows

    students.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.class}</td>
        <td>${s.age}</td>
        <td>${s.marks.math || 0}</td>
        <td>${s.marks.english || 0}</td>
        <td>${s.marks.science || 0}</td>
        <td>${s.marks.chemistry || 0}</td>
        <td>
          <button onclick="editStudent('${s._id}')">Edit</button>
          <button onclick="deleteStudent('${s._id}')">Delete</button>
          <button onclick = "findStudent('${s._id}')">Find</button>
        </td>
      `;
      studentsTableBody.appendChild(tr);
    });
  } catch (err) {
    console.error('Error loading students:', err);
  }
}

form.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(form);
  let marks = {};
  try {
    marks = formData.get('marks') ? JSON.parse(formData.get('marks')) : {};
  } catch {
    alert('Marks must be valid JSON');
    return;
  }

  const data = {
    name: formData.get('name'),
    class: formData.get('class'),
    age: Number(formData.get('age')),
    marks
  };

  let url = '/students';
  let method = 'POST';

  if (editingStudentId) {
    // If editing, update the student
    url = `/students/${editingStudentId}`;
    method = 'PUT';
  }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (res.ok) {
    form.reset();
    editingStudentId = null;
    form.querySelector('button').textContent = 'Add Student';
    loadStudents();
  } else {
    const error = await res.json();
    alert('Error: ' + (error.error || 'Failed to add/update student'));
  }
});

// Edit student function to load student data in form
async function editStudent(id) {
  try {
    const res = await fetch(`/students/${id}`);
    if (!res.ok) throw new Error('Student not found');
    const student = await res.json();

    form.name.value = student.name;
    form.class.value = student.class;
    form.age.value = student.age;
    form.marks.value = JSON.stringify(student.marks || {}, null, 2);

    editingStudentId = id;
    form.querySelector('button').textContent = 'Update Student';
  } catch (err) {
    alert('Error fetching student data');
  }
}

// Delete student function
async function deleteStudent(id) {
  if (!confirm('Are you sure you want to delete this student?')) return;

  try {
    const res = await fetch(`/students/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Failed to delete');
    loadStudents();
  } catch (err) {
    alert('Error deleting student');
  }
}

// Load students on page load
loadStudents();
</script>
<script src="index.js"></script>
</body>
</html>